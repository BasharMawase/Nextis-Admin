<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nextis Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <span class="logo-icon">ğŸ›¡ï¸</span>
            <h2>Nextis Admin</h2>
        </div>

        <div class="upload-section">
            <h3>×¤×¢×•×œ×•×ª</h3>
            <button class="btn-primary" style="width: 100%; margin-bottom: 24px;" onclick="openAddClientModal()">+ ×”×•×¡×£
                ×œ×§×•×— ×—×“×©</button>

            <h3>×”×¢×œ××ª × ×ª×•× ×™×</h3>
            <div class="upload-box" id="uploadBox">
                <p>×’×¨×•×¨ ×•×©×—×¨×¨ ×§×‘×¦×™× ×›××Ÿ</p>
                <p class="file-limit">×¢×“ 200MB ×œ×§×•×‘×¥ â€¢ XLSX, XLS, CSV</p>
                <button class="btn-upload" onclick="document.getElementById('fileInput').click()">×‘×—×¨ ×§×‘×¦×™×</button>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" multiple style="display: none;">
            </div>
        </div>

        <!-- Client Details Modal -->
        <div id="clientDetailsModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeClientDetailsModal()">&times;</span>
                <h2 id="detailBusinessName" style="margin-bottom: 20px; color: #e63946;"></h2>

                <div id="dynamicDetails" class="details-grid"></div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-primary" onclick="openEditClientModalFromDetails()"
                        style="background: #4a5568;">×¢×¨×•×š ×¤×¨×˜×™×</button>
                    <button class="btn-primary" onclick="closeClientDetailsModal()">×¡×’×•×¨</button>
                </div>
            </div>
        </div>


        <!-- Add Client Modal -->
        <div id="addClientModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeAddClientModal()">&times;</span>
                <h2>×”×•×¡×£ ×œ×§×•×— ×—×“×©</h2>
                <form id="addClientForm" onsubmit="submitAddClient(event)">
                    <div class="form-group">
                        <label>×©× ×¢×¡×§</label>
                        <input type="text" id="addName" required class="modal-input">
                    </div>
                    <div class="form-group">
                        <label>×¢×™×¨ / ××™×§×•×</label>
                        <input type="text" id="addLocation" required class="modal-input">
                    </div>
                    <div class="form-group">
                        <label>×˜×œ×¤×•×Ÿ</label>
                        <input type="text" id="addPhone" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label>AnyDesk</label>
                        <input type="text" id="addAnyDesk" class="modal-input">
                    </div>
                    <button type="submit" class="btn-primary modal-btn">×©××•×¨ ×œ×§×•×—</button>
                </form>
            </div>
        </div>

        <!-- Edit Client Modal -->
        <div id="editClientModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeEditClientModal()">&times;</span>
                <h2>×¢×¨×•×š ×¤×¨×˜×™ ×œ×§×•×—</h2>
                <form id="editClientForm" onsubmit="submitEditClient(event)">
                    <input type="hidden" id="editClientId">

                    <div id="dynamicEditFields" style="display: flex; flex-direction: column; gap: 15px;">
                        <!-- Fixed fields first, then dynamic ones will be injected here -->
                    </div>

                    <div
                        style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 12px; border: 1px solid rgba(139, 92, 246, 0.3); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <h4
                            style="margin: 0 0 15px 0; font-size: 1rem; color: #a78bfa; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2rem;">â•</span>
                            ×”×•×¡×£ ×©×“×” ××•×ª×× ××™×©×™×ª
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
                            <div>
                                <label
                                    style="display: block; margin-bottom: 5px; font-size: 0.85rem; color: #a0aec0;">×©×
                                    ×”×©×“×”</label>
                                <input type="text" id="newFieldName" placeholder="×œ×“×•×’××”: ×”×¢×¨×•×ª, ×¢×“×™×¤×•×ª..."
                                    class="modal-input" style="margin: 0;">
                            </div>
                            <div>
                                <label
                                    style="display: block; margin-bottom: 5px; font-size: 0.85rem; color: #a0aec0;">×¢×¨×š
                                    ×”×ª×—×œ×ª×™ (××•×¤×¦×™×•× ×œ×™)</label>
                                <input type="text" id="newFieldValue" placeholder="×”×–×Ÿ ×¢×¨×š..." class="modal-input"
                                    style="margin: 0;">
                            </div>
                            <button type="button" class="btn-primary" onclick="addNewFieldRow()"
                                style="background: linear-gradient(135deg, #8b5cf6, #6366f1); padding: 10px 20px; font-weight: bold; box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3); transition: all 0.2s;">
                                â• ×”×•×¡×£
                            </button>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary modal-btn" style="margin-top: 20px;">×©××•×¨ ×©×™× ×•×™×™×</button>
                </form>

            </div>
        </div>

        <!-- Edit Project Modal -->
        <div id="editProjectModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeEditProjectModal()">&times;</span>
                <h2>×¢×¨×•×š ×¤×¨×•×™×§×˜</h2>
                <form id="editProjectForm" onsubmit="submitEditProject(event)">
                    <input type="hidden" id="editProjectId">
                    <div class="form-group">
                        <label>×©× ×¤×¨×•×™×§×˜</label>
                        <input type="text" id="editTitle" required class="modal-input">
                    </div>
                    <div class="form-group">
                        <label>×ª×™××•×¨</label>
                        <textarea id="editDesc" required class="modal-input" style="height: 100px;"></textarea>
                    </div>
                    <div class="form-group">
                        <label>×ª××•× ×•×ª ×§×™×™××•×ª</label>
                        <div id="editExistingImages"
                            style="display: flex; gap: 10px; overflow-x: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 10px;">
                            <!-- Images will be loaded here -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label>×”×•×¡×£ ×ª××•× ×•×ª × ×•×¡×¤×•×ª</label>
                        <input type="file" id="editImageInput" accept="image/*" class="modal-input" multiple
                            onchange="previewImages(this, 'editImagePreview')">
                        <div id="editImagePreview" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary modal-btn">×©××•×¨ ×©×™× ×•×™×™×</button>

                </form>
            </div>
        </div>


    </div>

    <!-- Main Content -->
    <div class="main-content">
        <header>
            <h1>ğŸ›¡ï¸ ×œ×•×— ×‘×§×¨×” × ×™×”×•×œ×™</h1>
            <p>×”×¢×œ××ª ×§×‘×¦×™ ×œ×§×•×—×•×ª, ×—×™×¤×•×© ×¨×©×•××•×ª ×•×¦×¤×™×™×” ×‘× ×ª×•× ×™×.</p>
        </header>

        <div id="welcomeMessage" class="info-message">
            ğŸ‘‹ ×‘×¨×•×š ×”×‘×! ×× × ×”×¢×œ×” ×§×‘×¦×™ × ×ª×•× ×™× (Excel/CSV) ×“×¨×š ×”×ª×¤×¨×™×˜ ×”×¦×“×“×™.
        </div>

        <!-- Location Details Section (Initially Hidden) -->
        <section class="location-details-section" id="locationDetailsSection" style="display: none;">
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
                <button class="btn-back" onclick="closeLocationDetails()">â†’ ×—×–×¨×” ×œ×œ×•×— ×”×‘×§×¨×”</button>
                <h2 id="locationDetailsTitle">×œ×§×•×—×•×ª ×‘×¢×™×¨</h2>
            </div>

            <!-- In-City Search -->
            <input type="text" id="citySearchInput" class="search-input" placeholder="×—×¤×© ×œ×§×•×— ×‘×ª×•×š ×”×¢×™×¨..."
                style="margin-bottom: 24px;">

            <div id="locationClientsList"></div>
        </section>

        <!-- Search Section -->
        <section class="search-section" id="searchSection" style="display: none;">
            <h2>ğŸ” ×—×™×¤×•×© ×¢×¡×§</h2>
            <input type="text" id="searchInput" class="search-input" placeholder="×”×§×œ×“ ×©× ×¢×¡×§...">
            <div id="searchResults"></div>
        </section>

        <!-- Analytics Section -->
        <section class="analytics-section" id="analyticsSection" style="display: none;">
            <h2>ğŸ“Š × ×™×ª×•×— ×œ×¤×™ ×¢×¨×™× - 10 ×”××•×‘×™×œ×•×ª</h2>

            <div class="metrics">
                <div class="metric-card">
                    <div class="metric-label">×¡×”×´×› ×œ×§×•×—×•×ª</div>
                    <div class="metric-value" id="totalClients">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">×¢×¨×™× ×™×™×—×•×“×™×•×ª</div>
                    <div class="metric-value" id="uniqueLocations">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">×¢×™×¨ ××•×‘×™×œ×”</div>
                    <div class="metric-value" id="topLocation">N/A</div>
                </div>
            </div>

            <div class="locations-grid" id="locationsGrid"></div>
        </section>

        <!-- Portfolio Manager -->
        <div class="glass-card full-width" style="margin-top: 40px;">
            <h3>× ×™×”×•×œ ×ª×™×§ ×¢×‘×•×“×•×ª</h3>
            <div style="display: flex; gap: 20px; margin-bottom: 20px; align-items: flex-end;">
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #a0aec0;">×©×
                        ×”×¤×¨×•×™×§×˜</label>
                    <input type="text" id="projectTitle" placeholder="×©× ×”×¤×¨×•×™×§×˜" class="search-input">
                </div>
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #a0aec0;">×ª×™××•×¨
                        ×§×¦×¨</label>
                    <input type="text" id="projectDesc" placeholder="×ª×™××•×¨ ×§×¦×¨" class="search-input">
                </div>
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #a0aec0;">×ª××•× ×•×ª
                        (× ×™×ª×Ÿ
                        ×œ×‘×—×•×¨ ×›××”)</label>
                    <input type="file" id="projectImage" accept="image/*" class="search-input" style="padding: 10px;"
                        multiple onchange="previewImages(this, 'addProjectPreview')">
                    <div id="addProjectPreview" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                    </div>
                </div>
                <button onclick="addProject()" class="action-btn">×”×•×¡×£ ×¤×¨×•×™×§×˜</button>

            </div>
            <div id="projectsList" style="display: flex; flex-direction: column; gap: 30px;">
                <!-- Projects go here -->
            </div>
        </div>

        <!-- Data Matrix -->
        <div class="glass-card full-width">
            <h3>×××’×¨ × ×ª×•× ×™× ××œ×</h3>
            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <!-- Columns will be populated dynamically -->
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="pagination">
                <button id="prevPage" disabled>×”×§×•×“×</button>
                <span id="pageInfo">×¢××•×“ 1</span>
                <button id="nextPage">×”×‘×</button>
            </div>
        </div>

    </div>

    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <script>
        // Portfolio Management Logic
        let allProjects = [];

        async function loadProjects() {
            const res = await fetch('/api/projects');
            const projects = await res.json();
            allProjects = projects;
            const container = document.getElementById('projectsList');
            container.innerHTML = '';


            projects.forEach(p => {
                const div = document.createElement('div');
                div.className = 'glass-card';
                div.style.cssText = 'background: rgba(255,255,255,0.03); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.08);';

                let imagesHtml = '';
                p.images.forEach(img => {
                    imagesHtml += `
                        <div style="position: relative; min-width: 120px; height: 120px;">
                            <img src="${img.image_url}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                            <button onclick="deleteImage(${img.id})" style="position: absolute; top: 5px; right: 5px; background: rgba(230, 57, 70, 0.8); border: none; color: white; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center;">âœ•</button>
                        </div>
                    `;
                });

                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0; font-size: 1.2rem;">${p.title}</h4>
                            <p style="color: #a0aec0; margin: 5px 0 0 0;">${p.description}</p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="openEditProjectModal(${p.id}, '${p.title.replace(/'/g, "\\'")}', '${p.description.replace(/'/g, "\\'")}')" style="background:#4a5568; border:none; color:white; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight: bold;">×¢×¨×•×š</button>
                            <button onclick="deleteProject(${p.id})" style="background:#e63946; border:none; color:white; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight: bold;">××—×§ ×¤×¨×•×™×§×˜</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px;">
                        ${imagesHtml || '<p style="color: #666; font-style: italic;">××™×Ÿ ×ª××•× ×•×ª</p>'}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function addProject() {
            const title = document.getElementById('projectTitle').value;
            const desc = document.getElementById('projectDesc').value;
            const imageInput = document.getElementById('projectImage');

            if (!title || !desc || imageInput.files.length === 0) {
                return alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×•×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×ª××•× ×” ××—×ª');
            }

            const formData = new FormData();
            formData.append('title', title);
            formData.append('description', desc);
            for (let i = 0; i < imageInput.files.length; i++) {
                formData.append('image', imageInput.files[i]);
            }

            const res = await fetch('/api/projects', {
                method: 'POST',
                body: formData
            });

            if (res.ok) {
                document.getElementById('projectTitle').value = '';
                document.getElementById('projectDesc').value = '';
                document.getElementById('projectImage').value = '';
                document.getElementById('addProjectPreview').innerHTML = '';
                loadProjects();
            } else {

                alert('×©×’×™××” ×‘×”×¢×œ××ª ×”×¤×¨×•×™×§×˜');
            }
        }

        async function deleteProject(id) {
            if (!confirm('×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”×¤×¨×•×™×§×˜ ×•×”×ª××•× ×•×ª ×©×œ×•?')) return;
            await fetch(`/api/projects/${id}`, { method: 'DELETE' });
            loadProjects();
        }

        async function deleteImage(imageId, isFromEdit = false) {
            if (!confirm('×œ××—×•×§ ×ª××•× ×” ×–×•?')) return;
            await fetch(`/api/portfolio/images/${imageId}`, { method: 'DELETE' });

            if (isFromEdit) {
                const projectId = document.getElementById('editProjectId').value;
                // Refresh the edit modal's images
                const res = await fetch('/api/projects');
                allProjects = await res.json();
                const updatedProject = allProjects.find(p => p.id == projectId);
                renderEditImages(updatedProject.images);
            }
            loadProjects();
        }

        function previewImages(input, previewId) {
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';
            if (input.files) {
                [...input.files].forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.cssText = 'width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1);';
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        // Edit Project Modal Logic
        function openEditProjectModal(id, title, desc) {
            document.getElementById('editProjectId').value = id;
            document.getElementById('editTitle').value = title;
            document.getElementById('editDesc').value = desc;

            const project = allProjects.find(p => p.id == id);
            if (project) {
                renderEditImages(project.images);
            }

            document.getElementById('editImageInput').value = '';
            document.getElementById('editImagePreview').innerHTML = '';
            document.getElementById('editProjectModal').style.display = 'block';
        }

        function renderEditImages(images) {
            const container = document.getElementById('editExistingImages');
            if (!container) return;
            container.innerHTML = '';
            if (!images || images.length === 0) {
                container.innerHTML = '<p style="color: #666; font-size: 0.8rem;">××™×Ÿ ×ª××•× ×•×ª</p>';
                return;
            }

            images.forEach(img => {
                const div = document.createElement('div');
                div.style.cssText = 'position: relative; min-width: 80px; height: 80px;';
                div.innerHTML = `
                        <img src="${img.image_url}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">
                        <button type="button" onclick="deleteImage(${img.id}, true)" style="position: absolute; top: -5px; right: -5px; background: #e63946; border: none; color: white; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">âœ•</button>
                    `;
                container.appendChild(div);
            });
        }


        function closeEditProjectModal() {
            document.getElementById('editProjectModal').style.display = 'none';
        }

        async function submitEditProject(e) {
            e.preventDefault();
            const id = document.getElementById('editProjectId').value;
            const title = document.getElementById('editTitle').value;
            const desc = document.getElementById('editDesc').value;
            const fileInput = document.getElementById('editImageInput');

            const formData = new FormData();
            formData.append('title', title);
            formData.append('description', desc);
            for (let i = 0; i < fileInput.files.length; i++) {
                formData.append('image', fileInput.files[i]);
            }

            const res = await fetch(`/api/projects/${id}`, {
                method: 'POST',
                body: formData
            });

            if (res.ok) {
                closeEditProjectModal();
                loadProjects();
            } else {
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¤×¨×•×™×§×˜');
            }
        }

        // Load projects on page load
        loadProjects();
    </script>
</body>

</body>

</html>